rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isAdmin() {
      return request.auth != null && (request.auth.token.admin == true || request.auth.token.super_admin == true);
    }
    
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.super_admin == true;
    }

    // --- 1. USERS & PUBLIC PROFILES ---
    match /users/{userId} {
      // Public profiles: Everyone can read
      allow read: if true;
      
      // Create: User can create their own profile
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Update:  User can edit own profile (EXCEPT sensitive role fields)
      //          Super Admin can edit everything (including roles)
      // Update: Permissions for Users, Admins, and Super Admins
      // Update: Permissions for Users, Admins, Super Admins, AND Public Analytics
      allow update: if 
        // 1. Analytics: Allow ANYONE (including public) to update ONLY 'stats' (for views/taps)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats'])) ||
        
        // 2. Authenticated Management Rules
        (request.auth != null && (
          // A. User editing own profile (Restricted: Cannot change role/admin/ban status)
          (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'admin', 'super_admin', 'isBanned'])) ||
          
          // B. Super Admin (Unrestricted)
          isSuperAdmin() ||
          
          // C. Admin (Restricted: Can only update standard 'user' accounts, cannot change roles)
          (isAdmin() && (resource.data.role == 'user' || resource.data.role == null) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'admin', 'super_admin']))
        ));
      
      // Delete: Only user (or maybe super admin?)
      allow delete: if request.auth != null && request.auth.uid == userId;
      
      // 2. INTERACTIONS & CARDS (Sub-collections)
      match /interactions/{interactionId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      match /contacts/{contactId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      match /secrets/{secretId} {
        allow get: if true; // Public can read IF they know the specific PIN (secretId)
        allow list, write, delete: if request.auth != null && request.auth.uid == userId;
      }

      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // --- 2. ORDERS (Required for Admin Dashboard) ---
    match /orders/{orderId} {
      // User sees own orders; Admins see all
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      
      // CREATE: STRICT RULES
      // 1. Must be authenticated
      // 2. Must initially be 'pending_verification' (The Cloud Function will upgrade it to 'order_received')
      // 3. Users cannot create confirmed orders directly (Prevents Free Upgrade Hack)
      allow create: if request.auth != null && 
                    request.resource.data.status == 'pending_verification' &&
                    request.resource.data.userId == request.auth.uid;

      // UPDATE: RESTRICTED
      // Admins can update anything.
      // Users can NEVER update the status to 'order_received' or 'paid'.
      // Users can only update details if status is still pending/received
      allow update: if isAdmin(); 
      // Note: We removed user update permission to prevent tampering. 
      // If they need to change shipping, they should contact support or cancel/re-order.
    }

    // --- 3. QR CODES ---
    match /qr_codes/{qrId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
    }

    // --- 4. NFC CARD LINKS ---
    match /cards/{cardId} {
      allow read: if true;
      allow write: if request.auth != null; 
    }

    // --- 5. PLANS (Subscription Tiers) ---
    match /plans/{planId} {
      allow read: if true; // Public needs to see pricing
      allow write: if isAdmin(); // Only admins manage plans
    }

    // --- 6. SITE CONTENT (CMS) ---
    match /site_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 6. FORMS (Customization) ---
    match /forms/{formId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 7. REPORTS (Moderation) ---
    match /reports/{reportId} {
      // Create: Authenticated users can submit reports
      allow create: if request.auth != null;
      
      // Read: 
      // 1. Admins can read all reports
      // 2. Users can read their *own* submitted reports (to check 'already reported' status)
      //    We rely on the deterministic ID (reporterId_reportedUserId) or the reporterId field
      allow get: if request.auth != null && (isAdmin() || request.auth.uid == resource.data.reporterId);
      allow list: if isAdmin(); // Only admins can list/query all reports
      
      // Update/Delete: Only admins can resolve/dismiss
      allow update, delete: if isAdmin();
    }

    // --- 8. ADMIN ACTIONS (Logging) ---
    match /admin_actions/{actionId} {
      allow read, write: if isAdmin();
    }

    // --- 9. USERNAMES (Public Profile Resolution) ---
    match /usernames/{username} {
      allow read: if true;
      allow write: if request.auth != null && (
        isAdmin() || 
        (
          // Non-Admins:
          // 1. Length Check: Must be >= 5 chars (Only for Creation)
          // Note: If deleting, length doesn't matter.
          (request.method == 'delete' || username.size() >= 5) &&
          
          // 2. Ownership Check:
          // - If Creating: The 'uid' field must match their Auth UID.
          // - If Deleting: The existing doc's 'uid' must match their Auth UID.
          (request.method == 'delete' ? resource.data.uid == request.auth.uid : request.resource.data.uid == request.auth.uid) &&

          // 3. NO DIRECT UPDATES:
          // Users cannot overwrite an existing username document to change ownership or properties.
          // They can only CREATE (if it doesn't exist) or DELETE (if they own it).
          // Changing a username implies Creating the new one and Deleting the old one (handled by transaction in client).
          // But purely at the 'usernames' collection level:
          (request.method == 'create' || request.method == 'delete')
        )
      );
    }
  }
}